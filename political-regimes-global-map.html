<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Interactive visualization of global political regimes from 1789-2024. Explore democratic transitions and authoritarian persistence across 235 years of political history using V-Dem data.">
    <title>Political Regimes Across the Globe</title>
    <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 40px 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: #2c3e50;
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container {
            width: 100%;
            max-width: 1500px;
            text-align: center;
        }
        h1 {
            font-family: 'Times New Roman', serif;
            font-size: 52px;
            font-weight: 900;
            color: #1a1a1a;
            text-align: center;
            margin-bottom: 15px;
            letter-spacing: -0.5px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.08);
            line-height: 1.1;
        }
        p {
            text-align: center;
            color: #555;
            font-size: 18px;
            margin-bottom: 35px;
            line-height: 1.4;
        }
        .instructions {
            font-size: 14px;
            color: #777;
            font-style: italic;
            margin-top: 8px;
        }
        /* shared card style for maps */
        .map-card {
            margin: 18px auto;
            background: linear-gradient(135deg, #ffffff 0%, #fafafa 100%);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.12);
            padding: 18px;
            border: 1px solid rgba(0,0,0,0.05);
            width: fit-content;
        }
        /* keep #vis id available for JS but prefer .map-card for styling */
        #vis.map-card { 
            /* previously only margin-top; make width match the other embeds */
            width: 1400px;
            max-width: 100%;
            margin: 35px auto 0;
        }

        /* improved, unified legend styles */
		.legend-group {
			display:flex;
			flex-wrap:wrap;
			gap:12px;
			justify-content:center;
			align-items:center;
			margin:12px 0;
			padding:6px;
		}

		/* legend as pill / card */
		.legend-item {
			display:flex;
			align-items:center;
			gap:10px;
			padding:8px 12px;
			border-radius:12px;
			background:linear-gradient(180deg,#ffffff,#fbfdff);
			box-shadow:0 6px 18px rgba(20,30,40,0.06);
			border:1px solid rgba(15,25,35,0.06);
			cursor:pointer;
			transition:transform .12s ease, box-shadow .12s ease, background .12s ease;
			user-select:none;
			font-size:14px;
		}
		.legend-item:hover { transform:translateY(-4px); box-shadow:0 10px 28px rgba(20,30,40,0.09); }
		.legend-item:focus { outline:3px solid rgba(31,119,180,0.12); outline-offset:4px; }

		.legend-item[aria-pressed="true"] {
			background: linear-gradient(180deg,#1f77b4,#155a96);
			color:#fff;
			border-color: rgba(0,0,0,0.08);
		}

		.legend-swatch {
			width:20px;
			height:20px;
			border-radius:6px;
			flex:0 0 20px;
			box-shadow:inset 0 -2px 4px rgba(0,0,0,0.06);
			border:1px solid rgba(0,0,0,0.06);
		}

		.legend-label { font-weight:600; letter-spacing:0.1px; }
		.legend-sub { font-size:12px; opacity:0.8; margin-left:6px; }

		/* make the combined blocs legend visually distinct */
		.legend-group.legend-blocs { padding:10px 14px; border-radius:14px; background:linear-gradient(180deg,#f9fbff, #ffffff); }

        /* simple selector in normal flow */
        .map-selector {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 18px 0;
            z-index: 60;
        }
        .map-button {
            background: #fff;
            border: 1px solid rgba(0,0,0,0.08);
            padding: 8px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: #2c3e50;
            transition: all .12s ease;
        }
        .map-button.active,
        .map-button[aria-pressed="true"] {
            background: #1f77b4;
            color: white;
            box-shadow: 0 6px 18px rgba(31,119,180,0.12);
            transform: translateY(-1px);
        }
        .map-button:focus {
            outline: 3px solid rgba(31,119,180,0.14);
            outline-offset: 2px;
        }

        .legend-item.legend-highlight {
            background: linear-gradient(180deg,#1f77b4,#155a96);
            color: #fff;
            border-color: rgba(0,0,0,0.08);
            box-shadow: 0 10px 28px rgba(31,119,180,0.12);
            outline: 2px solid #1f77b4;
        }
        /* alliances map title + narrative */
        .alliance-header {
            text-align: center;
            margin-bottom: 8px;
        }
        .alliance-title {
            font-size: 20px;
            font-weight: 800;
            margin: 0 0 6px 0;
            color: #13334d;
        }
        .alliance-story {
            font-size: 13px;
            color: #345a6a;
            margin: 0;
            max-width: 960px;
            margin-left: auto;
            margin-right: auto;
        }

        /* regime map header (above viz1) */
        .viz-header {
            text-align: center;
            margin-bottom: 10px;
        }
        .viz-title {
            font-size: 20px;
            font-weight: 800;
            margin: 0 0 6px 0;
            color: #13334d;
        }
        .viz-story {
            font-size: 13px;
            color: #345a6a;
            margin: 0;
            max-width: 960px;
            margin-left: auto;
            margin-right: auto;
        }

        /* compact intro above alliance legends */
        .alliance-legend-intro {
            max-width: 1100px;
            margin: 0 auto 14px;
            text-align: center;
            color: #2f4858;
        }
        .alliance-legend-intro .lead { font-size:18px; font-weight:700; color:#122b3a; margin-bottom:6px; }
        .alliance-legend-intro .hint { font-size:13px; color:#546e7a; margin:0; }

        /* place compact map selector beside alliance intro */
        .alliance-legend-intro .map-selector {
            display: inline-flex;
            gap: 8px;
            margin-top: 10px;
            justify-content: center;
        }
        .alliance-legend-intro .map-button {
            padding: 6px 10px;
            font-size: 13px;
            border-radius: 6px;
        }
        @media (max-width:800px) {
            .alliance-legend-intro { padding: 0 12px; }
            .alliance-legend-intro .map-selector { width:100%; justify-content:center; margin-top:8px; }
            .alliance-legend-intro .map-button { flex:1 1 auto; }
        }

        /* small hint shown under the regime header */
        .event-hint {
            margin-top: 8px;
            font-size: 13px;
            color: #7a4b00;
            background: linear-gradient(90deg, rgba(255,223,0,0.06), rgba(255,250,230,0.02));
            display: inline-block;
            padding: 6px 10px;
            border-radius: 8px;
            border: 1px solid rgba(122,75,0,0.08);
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Political Regimes Across the Globe</h1>
        <p>Interactive visualization showing democratic transitions and authoritarian persistence, 1789-2024
        <br><span class="instructions">Use the year slider to explore different time periods | Hover over legend items to highlight regime types</span></p>
        
        <!-- Political legend: placed above the viz (left-to-right); No Data placed on the left -->
         <div class="legend-group legend-political" role="list" aria-label="Political legend">
            <div class="legend-item" data-regime="nodata" title="No data" role="button" tabindex="0" aria-pressed="false">
                <span class="legend-swatch" style="background:#ffffff; border:1px solid #ccc"></span><span class="legend-label">No data</span>
            </div>
            <div class="legend-item" data-regime="0" title="Closed Autocracy" role="button" tabindex="0" aria-pressed="false"><span class="legend-swatch" style="background:#ca0020"></span><span class="legend-label">Closed Autocracy</span></div>
            <div class="legend-item" data-regime="1" title="Electoral Autocracy" role="button" tabindex="0" aria-pressed="false"><span class="legend-swatch" style="background:#f4a582"></span><span class="legend-label">Electoral Autocracy</span></div>
            <div class="legend-item" data-regime="2" title="Electoral Democracy" role="button" tabindex="0" aria-pressed="false"><span class="legend-swatch" style="background:#92c5de"></span><span class="legend-label">Electoral Democracy</span></div>
            <div class="legend-item" data-regime="3" title="Liberal Democracy" role="button" tabindex="0" aria-pressed="false"><span class="legend-swatch" style="background:#0571b0"></span><span class="legend-label">Liberal Democracy</span></div>
        </div>
        <!-- Regime map header: sets the stage for the story -->
        <div class="viz-header" role="region" aria-live="polite">
            <div id="regime-vis-title" class="viz-title">Regime map - Who governs and how (by country)</div>
            <p id="regime-vis-story" class="viz-story">This map shows the dominant political regime in each country for the selected year. Observe concentrations of democracies and autocracies - these patterns often inform political and military alignments shown below.</p>
            <!-- NEW: hint about event markers -->
            <p class="event-hint" aria-hidden="false">Hover the yellow triangle markers on the map to see event details (year & description).</p>
        </div>
        <div id="vis" class="map-card" aria-labelledby="regime-vis-title"></div>

        <!-- removed: event banner (do not show banner/pop-up) -->

        <!-- ALLIANCES: compact intro (keeps story flow from regime map  alliances) -->
		<div style="margin-top: 60px;">
            <div class="alliance-legend-intro" role="note" aria-live="polite">
                <div class="lead">Blocs & Alliances - explore political and economic groupings</div>
                <p class="hint">Highlight a bloc to reveal its members; click to lock selection. Use the selector below to compare political/military vs economic groupings.</p>
                <div class="map-selector" role="tablist" aria-label="Choose alliances view">
                    <button type="button" class="map-button active" data-map="combined" aria-pressed="true" title="Political + Military">Political + Military</button>
                    <button type="button" class="map-button" data-map="economic" aria-pressed="false" title="Economic">Economic</button>
                </div>
            </div>

			<!-- NEW: alliance header that the JS will update to connect this view with the regime map above -->
			<div class="alliance-header" role="region" aria-live="polite" style="margin-bottom:14px;">
				<div id="alliance-vis-title" class="alliance-title">Political & Military Alliances often follow regime similarity</div>
				<p id="alliance-vis-story" class="alliance-story">Compare this alliances map with the regime map above - military and political blocs often cluster countries with similar regime types (e.g., democracies or autocracies). Use the selector to switch to economic groupings and observe where economic ties cross political lines.</p>
			</div>

            <!-- LEGENDS: re-added so the alliances view has interactive legend items -->
            <div class="legend-group legend-blocs-military" role="list" aria-label="Military blocs legend">
                <div class="legend-item" data-alliance="NATO" role="button" tabindex="0" aria-pressed="false">
                    <span class="legend-swatch" style="background:#0072B2"></span>
                    <span class="legend-label">NATO</span>
                    <span class="legend-sub">North Atlantic</span>
                </div>
                <div class="legend-item" data-alliance="CSTO" role="button" tabindex="0" aria-pressed="false">
                    <span class="legend-swatch" style="background:#D55E00"></span>
                    <span class="legend-label">CSTO</span>
                    <span class="legend-sub">Collective Security</span>
                </div>
                <div class="legend-item" data-alliance="SCO" role="button" tabindex="0" aria-pressed="false">
                    <span class="legend-swatch" style="background:#CC79A7"></span>
                    <span class="legend-label">SCO</span>
                    <span class="legend-sub">Shanghai Cooperation</span>
                </div>
                <div class="legend-item" data-alliance="AUKUS" role="button" tabindex="0" aria-pressed="false">
                    <span class="legend-swatch" style="background:#009E73"></span>
                    <span class="legend-label">AUKUS</span>
                    <span class="legend-sub">Indo-Pacific</span>
                </div>
                <div class="legend-item" data-alliance="ANZUS" role="button" tabindex="0" aria-pressed="false">
                    <span class="legend-swatch" style="background:#56B4E9"></span>
                    <span class="legend-label">ANZUS</span>
                    <span class="legend-sub">Pacific security</span>
                </div>
            </div>
            <div class="legend-group legend-blocs-economic" role="list" aria-label="Economic blocs legend" style="display:none">
                <div class="legend-item" data-alliance="EU" role="button" tabindex="0" aria-pressed="false">
                    <span class="legend-swatch" style="background:#E69F00"></span>
                    <span class="legend-label">EU</span>
                    <span class="legend-sub">European Union</span>
                </div>
                <div class="legend-item" data-alliance="BRICS" role="button" tabindex="0" aria-pressed="false">
                    <span class="legend-swatch" style="background:#F0E442"></span>
                    <span class="legend-label">BRICS</span>
                    <span class="legend-sub">Emerging economies</span>
                </div>
                <div class="legend-item" data-alliance="AU" role="button" tabindex="0" aria-pressed="false">
                    <span class="legend-swatch" style="background:#999999"></span>
                    <span class="legend-label">AU</span>
                    <span class="legend-sub">African Union</span>
                </div>
                <div class="legend-item" data-alliance="OAS" role="button" tabindex="0" aria-pressed="false">
                    <span class="legend-swatch" style="background:#66C2A5"></span>
                    <span class="legend-label">OAS</span>
                    <span class="legend-sub">Americas</span>
                </div>
                <div class="legend-item" data-alliance="ASEAN" role="button" tabindex="0" aria-pressed="false">
                    <span class="legend-swatch" style="background:#FC8D62"></span>
                    <span class="legend-label">ASEAN</span>
                    <span class="legend-sub">Southeast Asia</span>
                </div>
            </div>
        </div>

        <!-- ALLIANCES visualization (maps + legends) -->
		<div style="display:flex;flex-direction:column;align-items:center;gap:8px;margin-top:8px;">
 			<!-- force the embed container to match the Vega-Lite spec width (1400px)
 				     so projection translate/scale remain exact and highlights "stick" to the land -->
 				<div id="nato-vis" class="map-card" style="width:1400px; max-width:100%; margin:0 auto;"></div>
 				<div id="econ-vis" class="map-card" style="width:1400px; max-width:100%; margin:0 auto; display:none"></div>
 			</div>
		</div>
 
    <script>
         const spec = {
	"$schema": "https://vega.github.io/schema/vega-lite/v5.json",
	"autosize": {"type":"pad","contains":"padding"},
	"background": null,
	"padding": {"left": 15, "top": 15, "right": 15, "bottom": 15},
	"params": [
                 {
                     "name": "year_slider",
                     "value": 2020,
                     "bind": {
                         "input": "range",
                         "min": 1789,
                         "max": 2024,
                         "step": 1,
                         "name": "Year: "
                     }
                 },
                 { "name": "nodata_hover", "value": false },
                 { "name": "external_regime", "value": null }, /* JS-driven helper for legend highlighting */
                 { "name": "event_highlight", "value": null } /* NEW: event-driven regime highlight (array of regime codes) */
             ],
             "resolve": {"scale": {"color": "independent"}},
             "vconcat": [
                 {
                     "width": 1400,
                     "height": 750,
                     "layer": [
                         {
                             "data": {"sphere": true},
                             "mark": {
                                 "type": "geoshape",
                                 "fill": "#e8f4f8",
                                 "stroke": "#d1e7dd",
                                 "strokeWidth": 1
                             },
                             "projection": {"type":"naturalEarth1", "scale": 230, "translate": [700, 375]}
                         },
                         {
                             "data": {
                                 "url": "https://cdn.jsdelivr.net/npm/world-atlas@2/countries-50m.json",
                                 "format": {"type": "topojson", "feature": "countries"}
                             },
                             "mark": {
                                 "type": "geoshape",
                                 "fill": "#ffffff",
                                 "stroke": "#333333",
                                 "strokeWidth": 1.0
                             },
                             "encoding": {
                                 "tooltip": [
                                     {"field": "properties.name", "type": "nominal", "title": "Country"},
                                     {"value": "No data available", "title": "Status"},
                                     {"value": {"expr": "year_slider"}, "title": "Year"}
                                 ]
                             },
                             "projection": {"type": "naturalEarth1", "scale": 230, "translate": [700, 375]}
                         },
                         {
                             "data": {
                                 "values": [
                                        {"year":1789,"title":"French Revolution","desc":"Overthrow of monarchy; spread of republican and democratic ideals.","lon":2.35,"lat":48.85},
                                        {"year":1804,"title":"Haitian Independence","desc":"First successful slave revolt; reshaped colonial order in the Americas.","lon":-72.34,"lat":19.0},
                                        {"year":1848,"title":"Revolutions of 1848","desc":"Widespread liberal and nationalist uprisings across Europe.","lon":13.4,"lat":52.52},
                                        {"year":1917,"title":"Russian Revolution","desc":"Collapse of the Tsarist regime and rise of the Soviet state.","lon":37.62,"lat":55.76},
                                        {"year":1945,"title":"End of WWII","desc":"Defeat of Axis powers; occupation and regime reconfiguration across Europe and colonies.","lon":10.0,"lat":50.0},
                                        {"year":1947,"title":"Indian Independence","desc":"End of British rule; creation of democratic institutions in India.","lon":78.96,"lat":20.59},
                                        {"year":1949,"title":"Chinese Revolution","desc":"Establishment of the People's Republic of China; major regime change in Asia.","lon":116.40,"lat":39.90},
                                        {"year":1959,"title":"Cuban Revolution","desc":"Castro's revolution replaces authoritarian rule with a socialist state.","lon":-82.40,"lat":23.13}  ,
                                        {"year":1960,"title":"Year of Africa","desc":"17 African nations gain independence from colonial powers.","lon":20.0,"lat":0.0},
                                        {"year":1974,"title":"Carnation Revolution","desc":"Peaceful military coup ends Estado Novo dictatorship in Portugal.","lon":-9.14,"lat":38.72},
                                        {"year":1979,"title":"Iranian Revolution","desc":"Overthrow of Shah; establishment of Islamic Republic under Khomeini.","lon":51.39,"lat":35.69},
                                        {"year":1986,"title":"People Power Revolution","desc":"Nonviolent uprising ends Marcos dictatorship in the Philippines.","lon":121.77,"lat":12.88},
                                        {"year":1989,"title":"Fall of Berlin Wall","desc":"Symbolic end of Cold War; paves way for German reunification.","lon":13.38,"lat":52.52},
                                        {"year":1991,"title":"Dissolution of USSR","desc":"End of Soviet Union; emergence of independent republics.","lon":37.62,"lat":55.76},
                                        {"year":2003,"title":"Iraq Invasion","desc":"US-led coalition topples Saddam Hussein's regime.","lon":44.36,"lat":33.31},
                                        {"year":2011,"title":"Arab Spring","desc":"Series of uprisings leading to regime changes in several Arab countries.","lon":31.24,"lat":30.04},
                                        {"year":2014,"title":"Ukraine Crisis","desc":"Euromaidan protests lead to government change; annexation of Crimea by Russia.","lon":30.52,"lat":50.45},

                                 ]
                             },
                             // show annotation when slider is within ±5 years of the event
                             "transform": [
                                 {"filter":"abs(datum.year - year_slider) <= 5"}
                             ],
                             // make marker a yellow triangle with black stroke (triangle holds the "!" symbol)
                             "mark": {"type":"point","filled":true,"shape":"triangle","size":1400,"color":"#ffdf00","opacity":1.0,"stroke":"#000000","strokeWidth":2},
                             "encoding": {
                                 "longitude": {"field":"lon","type":"quantitative"},
                                 "latitude": {"field":"lat","type":"quantitative"},
                                 "tooltip": [
                                     {"field":"title","type":"nominal","title":"Event"},
                                     {"field":"desc","type":"nominal","title":"Description"},
                                     {"field":"year","type":"quantitative","title":"Year"}
                                 ]
                             },
                             "projection": {"type":"naturalEarth1","scale":230,"translate":[700,375]}
                         },

                         // overlay a centered "!" text on top of each triangle marker (black font)
                         {
                             "data": {
                                
                                 "values": [
                                     {"year":1789, "title":"French Revolution","desc":"Overthrow of monarchy and rise of republican ideals.","lon":2.35,"lat":48.86},
                                     {"year":1804, "title":"Haitian Revolution","desc":"Successful slave revolt leads to establishment of Haiti as first black republic.","lon":-72.34,"lat":19.0},
                                     {"year":1848, "title":"Revolutions of 1848","desc":"Widespread revolutionary wave across Europe advocating democracy.","lon":13.41,"lat":52.52},
                                     {"year":1917, "title":"Russian Revolution","desc":"Bolshevik uprising leads to establishment of a communist government.","lon":37.62,"lat":55.76},
                                     {"year":1945, "title":"End of WWII","desc":"Defeat of Axis powers leads to regime changes in Europe and colonies.","lon":10.0,"lat":50.0},
                                     {"year":1947, "title":"Indian Independence","desc":"End of British colonial rule and establishment of democratic governance.","lon":78.96,"lat":20.59},
                                     {"year":1949, "title":"Chinese Revolution","desc":"Communist Party takes control; establishment of the People's Republic of China.","lon":104.19,"lat":35.86},
                                     {"year":1959, "title":"Cuban Revolution","desc":"Fidel Castro overthrows Batista; establishment of socialist state.","lon":-82.40,"lat":23.13},
                                     {"year":1960, "title":"Year of Africa","desc":"17 African nations gain independence from colonial powers.","lon":20.0,"lat":0.0},
                                     {"year":1974, "title":"Carnation Revolution","desc":"Peaceful military coup ends dictatorship in Portugal.","lon":-9.14,"lat":38.72},
                                     {"year":1979, "title":"Iranian Revolution","desc":"Overthrow of Shah; establishment of Islamic Republic.","lon":51.39,"lat":35.69},
                                     {"year":1986, "title":"People Power Revolution","desc":"Nonviolent uprising ends Marcos dictatorship in the Philippines.","lon":121.77,"lat":12.88},
                                     {"year":1989, "title":"Fall of Berlin Wall","desc":"Symbolic end of Cold War; paves way for German reunification.","lon":13.38,"lat":52.52},
                                     {"year":1991, "title":"Dissolution of USSR","desc":"End of Soviet Union; emergence of independent republics.","lon":37.62,"lat":55.76},
                                     {"year":2003, "title":"Iraq Invasion","desc":"US-led coalition topples Saddam Hussein's regime.","lon":44.36,"lat":33.31},
                                     {"year":2011, "title":"Arab Spring","desc":"Series of uprisings leading to regime changes in several Arab countries.","lon":31.24,"lat":30.04},
                                     {"year":2014, "title":"Ukraine Crisis","desc":"Euromaidan protests lead to government change; annexation of Crimea by Russia.","lon":30.52,"lat":50.45}
                                 ]
                             },
                             "transform": [
                                 {"filter":"abs(datum.year - year_slider) <= 5"}
                             ],
                             "mark": {
                                 "type": "text",
                                 "text": "!",
                                 "fontSize": 22,
                                 "fontWeight": 700,
                                 "color": "#000000",
                                 "align": "center",
                                 "baseline": "middle"
                             },
                             "encoding": {
                                 "longitude": {"field":"lon","type":"quantitative"},
                                 "latitude": {"field":"lat","type":"quantitative"}
                             },
                             "projection": {"type":"naturalEarth1","scale":230,"translate":[700,375]}
                         },
                         {
                             "data": {"url": "political-regime-atlas.csv"},
                             "transform": [
                                 {"filter": "datum.Year == year_slider"},
                                 {
                                     "calculate": "datum['Political regime'] == '0' ? 'Closed Autocracy' : datum['Political regime'] == '1' ? 'Electoral Autocracy' : datum['Political regime'] == '2' ? 'Electoral Democracy' : datum['Political regime'] == '3' ? 'Liberal Democracy' : 'No Data'",
                                     "as": "Regime_Type"
                                 },
                                 {
                                     "lookup": "Entity",
                                     "from": {
                                         "data": {
                                             "url": "https://cdn.jsdelivr.net/npm/world-atlas@2/countries-50m.json",
                                             "format": {"type": "topojson", "feature": "countries"}
                                         },
                                         "key": "properties.name",
                                         "fields": ["type", "properties", "geometry"]
                                     }
                                 }
                             ],
                             "mark": {
                                 "type": "geoshape",
                                 "stroke": "white",
                                 "strokeWidth": 0.5
                             },
                             "encoding": {
                                 "color": {
                                     "condition": [
                                         {"test":"nodata_hover && datum.Regime_Type == 'No Data'","value":"#ffffff"}
                                     ],
                                     "field": "Political regime",
                                     "type": "ordinal",
                                     "scale": {
                                         "domain": ["0", "1", "2", "3"],
                                         "range": ["#ca0020", "#f4a582", "#92c5de", "#0571b0"]
                                     },
                                     "legend": null
                                 },
                                 "opacity": {
                                     "condition": [
                                         // emphasize regimes indicated by the current event (exact-year match)
                                         {"test": "event_highlight && indexof(event_highlight, toString(datum['Political regime'])) >= 0", "value": 1.0},
                                         {"test":"nodata_hover && datum.Regime_Type == 'No Data'","value": 1.0},
                                         {"test": "!regime_select.value && !external_regime", "value": 1.0},
                                         {"test": "toString(datum['Political regime']) == regime_select.value || toString(datum['Political regime']) == external_regime", "value": 1.0}
                                     ],
                                     "value": 0.18
                                 },
                                 "stroke": {
                                     "condition": [
                                         {"test": "event_highlight && indexof(event_highlight, toString(datum['Political regime'])) >= 0", "value": "#000000"},
                                         {"test":"nodata_hover && datum.Regime_Type == 'No Data'","value":"#000000"},
                                         {"test": "!regime_select.value && !external_regime", "value": "white"},
                                         {"test": "toString(datum['Political regime']) == regime_select.value || toString(datum['Political regime']) == external_regime", "value": "#000000"}
                                     ],
                                     "value": "white"
                                 },
                                 "strokeWidth": {
                                     "condition": [
                                         {"test": "event_highlight && indexof(event_highlight, toString(datum['Political regime'])) >= 0", "value": 2},
                                         {"test":"nodata_hover && datum.Regime_Type == 'No Data'","value": 1.5},
                                         {"test": "!regime_select.value && !external_regime", "value": 0.5},
                                         {"test": "toString(datum['Political regime']) == regime_select.value || toString(datum['Political regime']) == external_regime", "value": 2}
                                     ],
                                     "value": 0.5
                                 },
                                 "tooltip": [
                                     {"field": "Entity", "type": "nominal", "title": "Country/Territory"},
                                     {"field": "Regime_Type", "type": "nominal", "title": "Political Regime Classification"},
                                     {"field": "Year", "type": "ordinal", "title": "Reference Year"}
                                 ]
                             },
                             "projection": {"type": "naturalEarth1", "scale": 230, "translate": [700, 375]},
                             "params": [
                                 {
                                     "name": "regime_select",
                                     "select": {"type": "point", "fields": ["Political regime"], "on": "mouseover", "clear": "mouseout"}
                                 }
                             ]
                         },
                         {
                             "data": {"graticule": {"step": [30, 30]}},
                             "mark": {
                                 "type": "geoshape",
                                 "fill": null,
                                 "stroke": "#666666",
                                 "strokeWidth": 0.5,
                                 "opacity": 0.4
                             },
                             "projection": {"type": "naturalEarth1", "scale": 230, "translate": [700, 375]}
                         },
                         
                         // NEW: annotation point layer (visible when year_slider >= event.year)
                         {
                             "data": {
                                 "values": [
                                        {"year":1789,"title":"French Revolution","desc":"Overthrow of monarchy; spread of republican and democratic ideals.","lon":2.35,"lat":48.85},
                                        {"year":1804,"title":"Haitian Independence","desc":"First successful slave revolt; reshaped colonial order in the Americas.","lon":-72.34,"lat":19.0},
                                        {"year":1848,"title":"Revolutions of 1848","desc":"Widespread liberal and nationalist uprisings across Europe.","lon":13.4,"lat":52.52},
                                        {"year":1917,"title":"Russian Revolution","desc":"Collapse of the Tsarist regime and rise of the Soviet state.","lon":37.62,"lat":55.76},
                                        {"year":1945,"title":"End of WWII","desc":"Defeat of Axis powers; occupation and regime reconfiguration across Europe and colonies.","lon":10.0,"lat":50.0},
                                        {"year":1947,"title":"Indian Independence","desc":"End of British rule; creation of democratic institutions in India.","lon":78.96,"lat":20.59},
                                        {"year":1949,"title":"Chinese Revolution","desc":"Establishment of the People's Republic of China; major regime change in Asia.","lon":116.40,"lat":39.90},
                                        {"year":1959,"title":"Cuban Revolution","desc":"Castro's revolution replaces authoritarian rule with a socialist state.","lon":-82.38,"lat":23.11},
                                        {"year":1960,"title":"Year of Africa","desc":"17 African nations gain independence from colonial powers.","lon":20.0,"lat":0.0},
                                        {"year":1974,"title":"Carnation Revolution","desc":"Peaceful military coup ends Estado Novo dictatorship in Portugal.","lon":-9.14,"lat":38.72},
                                        {"year":1979,"title":"Iranian Revolution","desc":"Overthrow of Shah; establishment of Islamic Republic under Khomeini.","lon":51.39,"lat":35.69},
                                        {"year":1986,"title":"People Power Revolution","desc":"Nonviolent uprising ends Marcos dictatorship in the Philippines.","lon":121.77,"lat":12.88},
                                        {"year":1989,"title":"Fall of Berlin Wall","desc":"Symbolic end of Cold War; paves way for German reunification.","lon":13.38,"lat":52.52},
                                        {"year":1991,"title":"Dissolution of USSR","desc":"End of Soviet Union; emergence of independent republics and new regimes.","lon":37.62,"lat":55.76},
                                        {"year":2003,"title":"Iraq Invasion","desc":"US-led coalition topples Saddam Hussein's regime; begins occupation.","lon":44.37,"lat":33.32},
                                        {"year":2011,"title":"Arab Spring","desc":"Pro-democracy uprisings across Middle East and North Africa.","lon":20.0,"lat":30.0},
                                        {"year":2014,"title":"Ukraine Crisis","desc":"Euromaidan protests lead to government change; Russia annexes Crimea.","lon":30.52,"lat":50.45}
                                 ]
                             },
                             // show annotation when slider is within ±5 years of the event
                             "transform": [
                                 {"filter":"abs(datum.year - year_slider) <= 5"}
                             ],
                             // make marker a yellow triangle with black stroke (triangle holds the "!" symbol)
                             "mark": {"type":"point","filled":true,"shape":"triangle","size":1400,"color":"#ffdf00","opacity":1.0,"stroke":"#000000","strokeWidth":2},
                             "encoding": {
                                 "longitude": {"field":"lon","type":"quantitative"},
                                 "latitude": {"field":"lat","type":"quantitative"},
                                 "tooltip": [
                                     {"field":"title","type":"nominal","title":"Event"},
                                     {"field":"desc","type":"nominal","title":"Description"},
                                     {"field":"year","type":"quantitative","title":"Year"}
                                 ]
                             },
                             "projection": {"type":"naturalEarth1","scale":230,"translate":[700,375]}
                         },

                         // overlay a centered "!" text on top of each triangle marker (black font)
                         {
                             "data": {
                                 "values": [
                                     {"year":1789,"lon":2.35,"lat":48.85},
                                     {"year":1804,"lon":-72.34,"lat":19.0},
                                     {"year":1848,"lon":13.4,"lat":52.52},
                                     {"year":1917,"lon":37.62,"lat":55.76},
                                     {"year":1945,"lon":10.0,"lat":50.0},
                                     {"year":1947,"lon":78.96,"lat":20.59},
                                     {"year":1949,"lon":116.40,"lat":39.90},
                                     {"year":1959,"lon":-82.38,"lat":23.11},
                                     {"year":1960,"lon":20.0,"lat":0.0},
                                     {"year":1974,"lon":-9.14,"lat":38.72},
                                     {"year":1979,"lon":51.39,"lat":35.69},
                                     {"year":1986,"lon":121.77,"lat":12.88},
                                     {"year":1989,"lon":13.38,"lat":52.52},
                                     {"year":1991,"lon":37.62,"lat":55.76},
                                     {"year":2003,"lon":44.37,"lat":33.32},
                                     {"year":2011,"lon":20.0,"lat":30.0},
                                     {"year":2014,"lon":30.52,"lat":50.45},
                                 ]
                             },
                             "transform": [
                                 {"filter":"abs(datum.year - year_slider) <= 5"}
                             ],
                             "mark": {
                                 "type": "text",
                                 "text": "!",
                                 "fontSize": 22,
                                 "fontWeight": 700,
                                 "color": "#000000",
                                 "align": "center",
                                 "baseline": "middle"
                             },
                             "encoding": {
                                 "longitude": {"field":"lon","type":"quantitative"},
                                 "latitude": {"field":"lat","type":"quantitative"}
                             },
                             "projection": {"type":"naturalEarth1","scale":230,"translate":[700,375]}
                         }

                     ]
                 }
             ]
         };

         vegaEmbed('#vis', spec, { actions: false, renderer: 'svg', tooltip: true }).then(result => {
             // expose the view so external legend can control the selection
             window.politicalView = result.view;
             result.view.runAsync().catch(()=>{});
             console.log("Visualization (viz1) loaded successfully");

             // --- NEW: event defs mirrored in JS so we trigger highlights for ±5 years around an event ---
             const EVENT_DEFS = [
                        { year:1789, title:"French Revolution", desc:"Overthrow of monarchy; spread of republican and liberal ideas.", lon:2.35, lat:48.85 },
                        { year:1804, title:"Haitian Independence", desc:"First successful slave revolt; reshaped colonial order in the Americas.", lon:-72.34, lat:19.0 },
                        { year:1848, title:"Revolutions of 1848", desc:"Widespread liberal and nationalist uprisings across Europe.", lon:13.4, lat:52.52 },
                        { year:1917, title:"Russian Revolution", desc:"Collapse of the Tsarist regime and rise of the Soviet state.", lon:37.62, lat:55.76 },
                        { year:1945, title:"End of WWII", desc:"Defeat of Axis powers; occupation and regime reconfiguration across Europe and colonies.", lon:10.0, lat:50.0 },
                        { year:1947, title:"Indian Independence", desc:"End of British rule; creation of democratic institutions in India.", lon:78.96, lat:20.59 },
                        { year:1949, title:"Chinese Revolution", desc:"Establishment of the People's Republic of China; major regime change in Asia.", lon:116.40, lat:39.90 },
                        { year:1959, title:"Cuban Revolution", desc:"Castro's revolution replaces authoritarian rule with a communist state.", lon:-82.38, lat:23.11 },
                        { year:1960, title:"Year of Africa", desc:"Wave of decolonisation as many African states gain independence.", lon:20.0, lat:0.0 },
                        { year:1974, title:"Carnation Revolution", desc:"Peaceful coup ends Portugal's dictatorship and initiates democratization.", lon:-9.14, lat:38.72 },
                        { year:1979, title:"Iranian Revolution", desc:"Overthrow of the Shah and creation of the Islamic Republic.", lon:51.39, lat:35.69 },
                        { year:1986, title:"People Power (Philippines)", desc:"Popular uprising topples Marcos and restores democratic rule.", lon:121.77, lat:12.88 },
                        { year:1989, title:"Fall of Berlin Wall", desc:"Catalysed democratic transitions across Eastern Europe.", lon:13.38, lat:52.52 },
                        { year:1991, title:"Dissolution of USSR", desc:"Breakup of the Soviet Union and rapid regime change in former republics.", lon:37.62, lat:55.76 },
                        { year:2003, title:"Iraq invasion", desc:"External intervention results in regime overthrow and long-term political reorganisation.", lon:44.37, lat:33.32 },
                        { year:2011, title:"Arab Spring", desc:"Mass uprisings across North Africa and the Middle East, precipitating regime changes.", lon:20.0, lat:30.0 },
                        { year:2014, title:"Euromaidan (Ukraine)", desc:"Pro-European protests lead to government change and geopolitical realignment.", lon:30.52, lat:50.45 },
                    ];

            // compute highlights for any event within ±5 years of the current slider
            function computeEventHighlights(year) {
                const matched = EVENT_DEFS.filter(e => Math.abs(e.year - +year) <= 5);
                if (!matched.length) return null;
                const s = new Set();
                matched.forEach(m => (m.highlight || []).forEach(h => s.add(h)));
                return Array.from(s);
            }

            // return all matched events (array) within ±5 years
            function findEventsInRange(year) {
                return EVENT_DEFS.filter(e => Math.abs(e.year - +year) <= 5);
            }

            const banner = document.getElementById('event-banner');
            function showEventBanner(events) {
                if (!banner) return;
                if (!events || !events.length) { banner.style.display = 'none'; banner.textContent = ''; banner.classList.remove('pulse'); return; }
                // create concise multi-event summary
                const lines = events.map(ev => `${ev.year} - ${ev.title}: ${ev.desc}`);
                banner.innerHTML = lines.join('<br>');
                banner.style.display = 'block';
                // pulse once to draw attention (avoids change blindness)
                banner.classList.remove('pulse');
                void banner.offsetWidth;
                banner.classList.add('pulse');
            }

             // initialize event_highlight based on initial slider
             try {
                 const initialYear = result.view.signal('year_slider') || 2020;
                 const initialHighlights = computeEventHighlights(initialYear);
                 result.view.signal('event_highlight', initialHighlights);
                 const initialEvents = findEventsInRange(initialYear);
                 showEventBanner(initialEvents);
                 result.view.runAsync().catch(()=>{});
             } catch (e) { /* ignore */ }

             // update event_highlight whenever the year slider changes
             if (result.view.addSignalListener) {
                 result.view.addSignalListener('year_slider', (name, value) => {
                     const arr = computeEventHighlights(value);
                     result.view.signal('event_highlight', arr);
                     // update banner visibility / content for ±5-year window
                     const evs = findEventsInRange(value);
                     showEventBanner(evs);
                     result.view.runAsync().catch(()=>{});
                 });
             }

            // Move political legend into the embed so it appears below the map and above the bound controls (year slider)
            try {
                // embed element generated by vega-embed
                const embedContainer = document.querySelector('#vis .vega-embed') || document.getElementById('vis');
                const legend = document.querySelector('.legend-group.legend-political');
                if (embedContainer && legend) {
                    // Try to find the slider/input inside the embed and insert legend before it
                    const rangeInput = embedContainer.querySelector('input[type="range"], .vl-binding, .vega-bindings');
                    if (rangeInput) {
                        // If the rangeInput is an input, find nearest parent that groups controls
                        const target = rangeInput.closest('.vega-bindings, .vl-binding') || rangeInput.parentElement;
                        embedContainer.insertBefore(legend, target);
                    } else {
                        // fallback: append legend at the end of embed (still inside #vis)
                        embedContainer.appendChild(legend);
                    }
                    // Ensure the legend remains interactive and visible above the map
                    legend.style.display = 'flex';
                    legend.style.justifyContent = 'center';
                    legend.style.pointerEvents = 'auto';
                    legend.style.zIndex = '1000';
                }
            } catch (e) {
                console.warn('Could not relocate political legend into embed:', e);
            }

             // wire political legend -> viz1 (hover highlights; click locks)
             (function setupPoliticalLegend() {
                 if (!window.politicalView) return;
                 const items = Array.from(document.querySelectorAll('.legend-political .legend-item'));
                 let locked = null;
                 async function setRegimeSignal(val) {
                     try {
                         // set both the compiled selection signal and a simple external signal,
                         // so legend-driven highlights work reliably across builds
                         await window.politicalView.signal('regime_select', val);
                         await window.politicalView.signal('external_regime', val);
                         await window.politicalView.runAsync();
                     } catch (e) { console.warn('regime signal failed', e); }
                 }
                 async function setNodataSignal(flag) {
                     try {
                         await window.politicalView.signal('nodata_hover', flag);
                         await window.politicalView.runAsync();
                     } catch (e) { console.warn('nodata signal failed', e); }
                 }
                 items.forEach(it => {
                     const value = it.dataset.regime;
                     if (value === 'nodata') {
                         it.addEventListener('mouseenter', async () => {
                             if (locked === null) await setNodataSignal(true);
                         });
                         it.addEventListener('mouseleave', async () => {
                             if (locked === null) await setNodataSignal(false);
                         });
                         it.addEventListener('click', async () => {
                             if (locked === 'nodata') {
                                 locked = null;
                                 items.forEach(i => i.setAttribute('aria-pressed','false'));
                                 await setNodataSignal(false);
                             } else {
                                 locked = 'nodata';
                                 items.forEach(i => i.setAttribute('aria-pressed', i === it ? 'true' : 'false'));
                                 await setNodataSignal(true);
                             }
                         });
                         it.addEventListener('keydown', async ev => {
                             if (ev.key === 'Enter' || ev.key === ' ') { ev.preventDefault(); it.click(); }
                             else if (ev.key === 'Escape') { locked = null; items.forEach(i => i.setAttribute('aria-pressed','false')); await setNodataSignal(false); }
                         });
                     } else {
                         it.addEventListener('mouseenter', async () => {
                             if (locked === null) await setRegimeSignal(value);
                         });
                         it.addEventListener('mouseleave', async () => {
                             if (locked === null) await setRegimeSignal(null);
                         });
                         it.addEventListener('click', async () => {
                             // toggle lock for normal regimes
                             if (locked === value) {
                                 locked = null;
                                 items.forEach(i => i.setAttribute('aria-pressed','false'));
                                 await setRegimeSignal(null);
                             } else {
                                 locked = value;
                                 items.forEach(i => i.setAttribute('aria-pressed', i === it ? 'true' : 'false'));
                                 // ensure nodata unlocked
                                 await setNodataSignal(false);
                                 await setRegimeSignal(value);
                             }
                         });
                         it.addEventListener('keydown', async ev => {
                             if (ev.key === 'Enter' || ev.key === ' ') { ev.preventDefault(); it.click(); }
                             else if (ev.key === 'Escape') { locked = null; items.forEach(i => i.setAttribute('aria-pressed','false')); await setRegimeSignal(null); await setNodataSignal(false); }
                         });
                     }
                 });
             })();
         }).catch(error => {
             console.error('Error loading visualization:', error);
         });
    </script>
<script>
    // MAP 2: Military alliances (NATO, CSTO, AUKUS, ANZUS) + Economic (ODA)
    const allianceSpec = {
	"$schema": "https://vega.github.io/schema/vega-lite/v5.json",
	"autosize": {"type":"pad","contains":"padding"},
	"background": null,
	"padding": {"left": 15, "top": 15, "right": 15, "bottom": 15},
	"params": [
            { "name": "external_alliance", "value": null }
        ],
        "resolve": {"scale": {"color": "independent"}},
        "vconcat": [
            {
                "width": 1400,
                "height": 750,
                "layer": [
                    {
                        "data": {"sphere": true},
                        "mark": {
                            "type": "geoshape",
                            "fill": "#e8f4f8",
                            "stroke": "#d1e7dd",
                            "strokeWidth": 1
                        },
                        "projection": {"type":"naturalEarth1","scale":230,"translate":[700,375]}
                    },
                    {
                        "data": {
                            "url": "https://cdn.jsdelivr.net/npm/world-atlas@2/countries-50m.json",
                            "format": {"type": "topojson", "feature": "countries"}
                        },
                        "mark": {
                            "type": "geoshape",
                            "fill": "#ffffff",
                            "stroke": "#333333",
                            "strokeWidth": 1.0
                        },
                        "encoding": {
                            "tooltip": [
                                {"field": "properties.name", "type": "nominal", "title": "Country"},
                                {"value": "No data available", "title": "Status"}
                            ]
                        },
                        // ensure this base layer uses the same projection
                        "projection": {"type":"naturalEarth1","scale":230,"translate":[700,375]}
                    },
                    {
                      // Draw countries from topojson, then lookup membership fields from CSV.
                      // Compute explicit boolean flags so multi-membership highlights correctly.
                      "data": {
                        "url": "https://cdn.jsdelivr.net/npm/world-atlas@2/countries-50m.json",
                        "format": {"type":"topojson","feature":"countries"}
                      },
                      "transform": [
	// start with the raw topojson name
	{"calculate": "datum.properties && datum.properties.name ? datum.properties.name : null", "as": "lookupName"},
	// map common variants to CSV Country values (do one replacement per calculate for clarity)
	{"calculate": "(datum.lookupName == \"Lao People's Democratic Republic\" || datum.lookupName == 'Lao PDR' || datum.lookupName == 'Lao') ? 'Laos' : datum.lookupName", "as": "lookupName"},
	{"calculate": "(datum.lookupName == 'Burma' || datum.lookupName == 'Myanmar (Burma)' || datum.lookupName == 'Republic of the Union of Myanmar' || datum.lookupName == 'Myanmar') ? 'Myanmar' : datum.lookupName", "as": "lookupName"},
	{"calculate": "(datum.lookupName == 'Viet Nam' || datum.lookupName == 'VietNam') ? 'Vietnam' : datum.lookupName", "as": "lookupName"},
	{"calculate": "(datum.lookupName == 'Russian Federation' || datum.lookupName == 'Russia (Federation)') ? 'Russia' : datum.lookupName", "as": "lookupName"},
	{"calculate": "(datum.lookupName == 'United States' || datum.lookupName == 'United States of America (the)') ? 'United States of America' : datum.lookupName", "as": "lookupName"},
	{"calculate": "(datum.lookupName == 'Congo, Dem. Rep.' || datum.lookupName == 'Democratic Republic of the Congo' || datum.lookupName == 'DR Congo') ? 'Democratic Republic of the Congo' : datum.lookupName", "as": "lookupName"},
	{"calculate": "(datum.lookupName == 'Congo' || datum.lookupName == 'Republic of the Congo' || datum.lookupName == 'Congo, Rep.') ? 'Republic of the Congo' : datum.lookupName", "as": "lookupName"},
	{"calculate": "(datum.lookupName == 'Republic of Korea' || datum.lookupName == 'Korea, Republic of') ? 'Republic of Korea' : datum.lookupName", "as": "lookupName"},
	{"calculate": "(datum.lookupName == 'Iran (Islamic Republic of)' || datum.lookupName == 'Iran') ? 'Iran' : datum.lookupName", "as": "lookupName"},
	// lookup membership fields from CSV using the normalized name
	{
		"lookup": "lookupName",
		"from": {
			"data": {"url":"Country_metadata_checked.csv"},
			"key": "Country",
			"fields": ["NATO","CSTO","AUKUS","ANZUS","EU","BRICS","ASEAN","AU","OAS","SCO","UNSD Regions"]
		}
	},
	// ensure AU is explicit: prefer CSV AU value, otherwise infer from UNSD Regions and expose as AU_filled
	{"calculate":"(datum.AU && datum.AU.length ? datum.AU : (datum['UNSD Regions'] && indexof(datum['UNSD Regions'], 'Africa') >= 0 ? 'M' : ''))","as":"AU_filled"},
                        // boolean flags for each bloc (accept 'M','1','Y')
                        {"calculate":"(datum.NATO=='M' || datum.NATO=='1' || datum.NATO=='Y')","as":"isNATO"},
                        {"calculate":"(datum.CSTO=='M' || datum.CSTO=='1' || datum.CSTO=='Y')","as":"isCSTO"},
                        {"calculate":"(datum.SCO=='M' || datum.SCO=='1' || datum.SCO=='Y')","as":"isSCO"},
                        {"calculate":"(datum.AUKUS=='M' || datum.AUKUS=='1' || datum.AUKUS=='Y')","as":"isAUKUS"},
                        {"calculate":"(datum.ANZUS=='M' || datum.ANZUS=='1' || datum.ANZUS=='Y')","as":"isANZUS"},
                        {"calculate":"(datum.EU=='M' || datum.EU=='1' || datum.EU=='Y')","as":"isEU"},
                        {"calculate":"(datum.BRICS=='M' || datum.BRICS=='1' || datum.BRICS=='Y')","as":"isBRICS"},
                        // treat as AU member if AU_filled indicates membership
                        {"calculate":"(datum.AU_filled=='M' || datum.AU_filled=='1' || datum.AU_filled=='Y')","as":"isAU"},
                        {"calculate":"(datum.OAS=='M' || datum.OAS=='1' || datum.OAS=='Y')","as":"isOAS"},
                        {"calculate":"(datum.ASEAN=='M' || datum.ASEAN=='1' || datum.ASEAN=='Y')","as":"isASEAN"},
                        // fallback: treat some topojson variants as ASEAN members if lookup failed
                        {"calculate":"(datum.isASEAN || datum.lookupName=='Laos' || datum.lookupName=='Lao P.D.R.' || datum.lookupName=='Lao PDR' || datum.lookupName=='Myanmar' || datum.lookupName=='Burma')","as":"isASEAN_final"},
                        // compute a single text field listing the blocs (used by tooltip)  array + join approach
                      ],
                      "mark": {
                          "type": "geoshape",
                          "stroke": "white",
                          "strokeWidth": 0.5
                      },
                      "encoding": {
                        /* Color by membership only when external_alliance contains that bloc.
                           Use indexof(external_alliance, ... ) >= 0 so arrays are supported. */
                        "color": {
                          "condition": [
                            {"test":"external_alliance && indexof(external_alliance, 'NATO') >= 0 && datum.isNATO", "value":"#0072B2"},
                            {"test":"external_alliance && indexof(external_alliance, 'CSTO') >= 0 && datum.isCSTO", "value":"#D55E00"},
                            {"test":"external_alliance && indexof(external_alliance, 'SCO') >= 0 && datum.isSCO", "value":"#CC79A7"},
                            {"test":"external_alliance && indexof(external_alliance, 'AUKUS') >= 0 && datum.isAUKUS", "value":"#009E73"},
                            {"test":"external_alliance && indexof(external_alliance, 'ANZUS') >= 0 && datum.isANZUS", "value":"#56B4E9"},
                            {"test":"external_alliance && indexof(external_alliance, 'EU') >= 0 && datum.isEU", "value":"#E69F00"},
                            {"test":"external_alliance && indexof(external_alliance, 'BRICS') >= 0 && datum.isBRICS", "value":"#F0E442"},
                            {"test":"external_alliance && indexof(external_alliance, 'AU') >= 0 && datum.isAU", "value":"#999999"},
                            {"test":"external_alliance && indexof(external_alliance, 'OAS') >= 0 && datum.isOAS", "value":"#66C2A5"},
                            {"test":"external_alliance && indexof(external_alliance, 'ASEAN') >= 0 && datum.isASEAN_final", "value":"#FC8D62"}
                          ],
                          "value": "#f0f0f0"
                        },
                        /* Opacity: show full opacity for any member of any selected/hovered bloc; otherwise faded */
                        "opacity": {
                          "condition": [
                            {"test":"external_alliance && indexof(external_alliance, 'NATO') >= 0 && datum.isNATO", "value":1},
                            {"test":"external_alliance && indexof(external_alliance, 'CSTO') >= 0 && datum.isCSTO", "value":1},
                            {"test":"external_alliance && indexof(external_alliance, 'SCO') >= 0 && datum.isSCO", "value":1},
                            {"test":"external_alliance && indexof(external_alliance, 'AUKUS') >= 0 && datum.isAUKUS", "value":1},
                            {"test":"external_alliance && indexof(external_alliance, 'ANZUS') >= 0 && datum.isANZUS", "value":1},
                            {"test":"external_alliance && indexof(external_alliance, 'EU') >= 0 && datum.isEU", "value":1},
                            {"test":"external_alliance && indexof(external_alliance, 'BRICS') >= 0 && datum.isBRICS", "value":1},
                            {"test":"external_alliance && indexof(external_alliance, 'AU') >= 0 && datum.isAU", "value":1},
                            {"test":"external_alliance && indexof(external_alliance, 'OAS') >= 0 && datum.isOAS", "value":1},
                            {"test":"external_alliance && indexof(external_alliance, 'ASEAN') >= 0 && datum.isASEAN_final", "value":1}
                          ],
                          "value": 0.12
                        },
                        /* Stroke: emphasize selected bloc members */
                        "stroke": {
                          "condition": [
                            {"test":"external_alliance && indexof(external_alliance, 'NATO') >= 0 && datum.isNATO", "value":"#000000"},
                            {"test":"external_alliance && indexof(external_alliance, 'CSTO') >= 0 && datum.isCSTO", "value":"#000000"},
                            {"test":"external_alliance && indexof(external_alliance, 'SCO') >= 0 && datum.isSCO", "value":"#000000"},
                            {"test":"external_alliance && indexof(external_alliance, 'AUKUS') >= 0 && datum.isAUKUS", "value":"#000000"},
                            {"test":"external_alliance && indexof(external_alliance, 'ANZUS') >= 0 && datum.isANZUS", "value":"#000000"},
                            {"test":"external_alliance && indexof(external_alliance, 'EU') >= 0 && datum.isEU", "value":"#000000"},
                            {"test":"external_alliance && indexof(external_alliance, 'BRICS') >= 0 && datum.isBRICS", "value":"#000000"},
                            {"test":"external_alliance && indexof(external_alliance, 'AU') >= 0 && datum.isAU", "value":"#000000"},
                            {"test":"external_alliance && indexof(external_alliance, 'OAS') >= 0 && datum.isOAS", "value":"#000000"},
                            {"test":"external_alliance && indexof(external_alliance, 'ASEAN') >= 0 && datum.isASEAN_final", "value":"#000000"}
                          ],
                          "value":"white"
                        },
                        "strokeWidth": {
                          "condition": [
                            {"test":"external_alliance && indexof(external_alliance, 'NATO') >= 0 && datum.isNATO", "value":2},
                            {"test":"external_alliance && indexof(external_alliance, 'CSTO') >= 0 && datum.isCSTO", "value":2},
                            {"test":"external_alliance && indexof(external_alliance, 'SCO') >= 0 && datum.isSCO", "value":2},
                            {"test":"external_alliance && indexof(external_alliance, 'AUKUS') >= 0 && datum.isAUKUS", "value":2},
                            {"test":"external_alliance && indexof(external_alliance, 'ANZUS') >= 0 && datum.isANZUS", "value":2},
                            {"test":"external_alliance && indexof(external_alliance, 'EU') >= 0 && datum.isEU", "value":2},
                            {"test":"external_alliance && indexof(external_alliance, 'BRICS') >= 0 && datum.isBRICS", "value":2},
                            {"test":"external_alliance && indexof(external_alliance, 'AU') >= 0 && datum.isAU", "value":2},
                            {"test":"external_alliance && indexof(external_alliance, 'OAS') >= 0 && datum.isOAS", "value":2},
                            {"test":"external_alliance && indexof(external_alliance, 'ASEAN') >= 0 && datum.isASEAN_final", "value":2}
                          ],
                          "value":0.5
                        },
                       
                      },
                      // projection for the membership layer
                      "projection": {"type":"naturalEarth1","scale":230,"translate":[700,375]}
                    },
                    {
                        "data": {"graticule": {"step": [30, 30]}},
                        "mark": {
                            "type": "geoshape",
                            "fill": null,
                            "stroke": "#666666",
                            "strokeWidth": 0.5,
                            "opacity": 0.4
                        },
                        // graticule must also use the same projection
                        "projection": {"type":"naturalEarth1","scale":230,"translate":[700,375]}
                    }
                ]
            }
        ]
    };

    vegaEmbed('#nato-vis', allianceSpec, { actions: false, renderer: 'svg' }).then(result => {
        window.allianceView = result.view;
        result.view.runAsync().catch(()=>{});
        console.log("Visualization (viz2) loaded successfully");

        // --- Reusable custom lightweight tooltip for alliances maps ---
        function setupAllianceTooltip(view) {
            // create one tooltip element if it does not exist
            let tt = document.getElementById('alliance-tooltip');
            if (!tt) {
                tt = document.createElement('div');
                tt.id = 'alliance-tooltip';
                tt.style.cssText = [
                    'position:fixed',
                    'pointer-events:none',
                    'padding:8px 10px',
                    'background:rgba(0,0,0,0.78)',
                    'color:#fff',
                    'border-radius:6px',
                    'font-size:13px',
                    'line-height:1.2',
                    'max-width:320px',
                    'display:none',
                    'z-index:2147483647'
                ].join(';');
                document.body.appendChild(tt);
            }

            // explicit major blocs (order matters for readability)
            const majors = [
                { key: 'isNATO', label: 'NATO' },
                { key: 'isCSTO', label: 'CSTO' },
                { key: 'isSCO', label: 'SCO' },
                { key: 'isAUKUS', label: 'AUKUS' },
                { key: 'isANZUS', label: 'ANZUS' },
                { key: 'isEU', label: 'EU' },
                { key: 'isBRICS', label: 'BRICS' },
                { key: 'isAU', label: 'AU' },
                { key: 'isOAS', label: 'OAS' },
                { key: 'isASEAN_final', label: 'ASEAN' }
            ];

            function blocsForDatum(d) {
                if (!d) return 'None';
                const list = majors.filter(m => !!d[m.key]).map(m => m.label);
                return list.length ? list.join(', ') : 'None';
            }

            // attach listeners for this view (re-using the single tt element)
            view.addEventListener('mouseover', (event, item) => {
                try {
                    const d = item && (item.datum || item.datum.datum) ? (item.datum || item.datum.datum) : null;
                    if (!d) return;
                    const name = (d.properties && (d.properties.name || d.lookupName)) || d.lookupName || 'Unknown';
                    tt.innerHTML = `<strong>Country: ${name}</strong><div style="opacity:.9;margin-top:6px;">Blocs: ${blocsForDatum(d)}</div>`;
                    tt.style.display = 'block';
                } catch (e) { /* ignore */ }
            });
            view.addEventListener('mousemove', (event) => {
                if (tt.style.display === 'none') return;
                const ex = event.clientX || (event && event.pageX) || 0;
                const ey = event.clientY || (event && event.pageY) || 0;
                const pad = 12;
                tt.style.left = (ex + pad) + 'px';
                tt.style.top = (ey + pad) + 'px';
            });
            view.addEventListener('mouseout', (event, item) => {
                tt.style.display = 'none';
            });
        }

        // attach tooltip to the primary view
        setupAllianceTooltip(result.view);

        // also instantiate the econ embed so econ-vis isn't empty when toggled
        vegaEmbed('#econ-vis', allianceSpec, { actions: false, renderer: 'svg' }).then(res => {
            window.allianceViewEcon = res.view;
            res.view.runAsync().catch(()=>{});
            // attach same tooltip to econ view (shares single tooltip DOM)
            setupAllianceTooltip(res.view);
            console.log("Visualization (viz2 econ) loaded successfully");
        }).catch(e => console.warn('econ embed failed', e));

        // --- REDO LEGEND INTERACTIVITY (support military + economic legend groups) ---
        const legendGroupMil = document.querySelector('.legend-blocs-military');
        const legendGroupEcon = document.querySelector('.legend-blocs-economic');
        const legendItems = Array.from(document.querySelectorAll('.legend-blocs-military .legend-item, .legend-blocs-economic .legend-item'));
         const selectedSet = new Set();
         const hoverSet = new Set();
 
         function updateLegendVisuals() {
             legendItems.forEach(i => {
                 const v = i.dataset.alliance;
                 const active = selectedSet.has(v) || hoverSet.has(v);
                 i.classList.toggle('legend-highlight', !!active);
                 // aria-pressed reflects persistent selection only
                 i.setAttribute('aria-pressed', selectedSet.has(v) ? 'true' : 'false');
             });
         }
 
         function getCombinedArray() {
             const arr = Array.from(new Set([...selectedSet, ...hoverSet]));
             return arr.length ? arr : null;
         }
 
         async function updateSignal() {
             try {
                 const arr = getCombinedArray();
                 // set signal on primary view
                 if (window.allianceView) {
                    await window.allianceView.signal('external_alliance', arr);
                    await window.allianceView.runAsync();
                 }
                 // set signal on econ view if present
                 if (window.allianceViewEcon) {
                    await window.allianceViewEcon.signal('external_alliance', arr);
                    await window.allianceViewEcon.runAsync();
                 }
             } catch (e) { console.warn('alliance signal failed', e); }
         }
 
         // pointer interactions
         legendItems.forEach(item => {
             const value = item.dataset.alliance;
 
             item.addEventListener('pointerenter', async () => {
                 hoverSet.add(value);
                 updateLegendVisuals();
                 await updateSignal();
             });
 
             item.addEventListener('pointerleave', async () => {
                 hoverSet.delete(value);
                 updateLegendVisuals();
                 await updateSignal();
             });
 
             item.addEventListener('click', async (ev) => {
                 // toggle persistent selection
                 if (selectedSet.has(value)) selectedSet.delete(value);
                 else selectedSet.add(value);
                 // update visuals/signal (selectedSet takes precedence but combined array is used)
                 updateLegendVisuals();
                 await updateSignal();
                 ev.stopPropagation();
             });
 
             item.addEventListener('keydown', async ev => {
                 if (ev.key === 'Enter' || ev.key === ' ') { ev.preventDefault(); item.click(); }
                 else if (ev.key === 'Escape') { selectedSet.clear(); hoverSet.clear(); updateLegendVisuals(); await updateSignal(); }
             });
         });
 
         // clear hover when leaving whole legend, but keep selectedSet intact
         const allLegendGroups = [legendGroupMil, legendGroupEcon].filter(Boolean);
         allLegendGroups.forEach(g => {
             g.addEventListener('pointerleave', async () => {
                 if (hoverSet.size) {
                     hoverSet.clear();
                     updateLegendVisuals();
                     await updateSignal();
                 }
             });
             g.addEventListener('touchend', async () => {
                 if (hoverSet.size) {
                     hoverSet.clear();
                     updateLegendVisuals();
                     await updateSignal();
                 }
             });
         });
 
         // clicking outside clears only hover; to clear all selections require clicking the active legends again
         document.addEventListener('pointerdown', async (e) => {
             const insideAny = allLegendGroups.some(g => g && g.contains(e.target));
             if (!insideAny && hoverSet.size) {
                hoverSet.clear();
                updateLegendVisuals();
                await updateSignal();
             }
         });
 
        // --- Add highlight style ---
        const style = document.createElement('style');
        style.innerHTML = `
            .legend-blocs .legend-item.legend-highlight {
                box-shadow: 0 0 0 3px #1f77b455;
                border-color: #1f77b4;
                background: linear-gradient(180deg,#eaf3fa,#e7f0fa);
            }
        `;
        document.head.appendChild(style);

        // --- MAP SELECTOR: show/hide NATO vs Economic maps and their legend groups ---
        (function setupMapSelector() {
            const buttons = Array.from(document.querySelectorAll('.map-button'));
            const natoDiv = document.getElementById('nato-vis');
            const econDiv = document.getElementById('econ-vis');
            const legendMil = document.querySelector('.legend-blocs-military');
            const legendEcon = document.querySelector('.legend-blocs-economic');
            const titleEl = document.getElementById('alliance-vis-title');
            const storyEl = document.getElementById('alliance-vis-story');
             buttons.forEach(btn => {
                 btn.addEventListener('click', () => {
                     const map = btn.dataset.map;
                     buttons.forEach(b => {
                         const isActive = b === btn;
                         b.classList.toggle('active', isActive);
                         b.setAttribute('aria-pressed', isActive ? 'true' : 'false');
                     });
                     if (map === 'combined') {
                         natoDiv.style.display = 'block';
                         econDiv.style.display = 'none';
                         if (legendMil) legendMil.style.display = 'flex';
                         if (legendEcon) legendEcon.style.display = 'none';
                         if (titleEl) titleEl.textContent = 'Political & Military Alliances often follow regime similarity';
                         if (storyEl) storyEl.textContent = 'Use the legend to highlight a military/political bloc. Compare its members to the regime map above - you will often see similar regime types grouped together.';
                     } else if (map === 'economic') {
                         natoDiv.style.display = 'none';
                         econDiv.style.display = 'block';
                         if (legendMil) legendMil.style.display = 'none';
                         if (legendEcon) legendEcon.style.display = 'flex';
                         if (titleEl) titleEl.textContent = 'Economic Trade, aid and partnerships that cross political lines';
                         if (storyEl) storyEl.textContent = 'Highlight an economic bloc to see members that may span democracies and autocracies. This view helps reveal where economic ties differ from political/military alignments shown above.';
                     }
                 });
                 btn.addEventListener('keydown', ev => {
                     if (ev.key === 'Enter' || ev.key === ' ') { ev.preventDefault(); btn.click(); }
                 });
             });
             // ensure initial visibility matches initial active button
             const activeBtn = document.querySelector('.map-button.active');
             if (activeBtn && activeBtn.dataset.map === 'combined') {
                 if (legendMil) legendMil.style.display = 'flex';
                 if (legendEcon) legendEcon.style.display = 'none';
                 // initial narrative already set in DOM; no change needed
             } else {
                 if (legendMil) legendMil.style.display = 'none';
                 if (legendEcon) legendEcon.style.display = 'flex';
                // set narrative for economic initial state
                if (titleEl) titleEl.textContent = 'Economic Trade, aid and partnerships that cross political lines';
                if (storyEl) storyEl.textContent = 'Highlight an economic bloc to see members that may span democracies and autocracies. This view helps reveal where economic ties differ from political/military alignments shown above.';
             }
         })();
    }).catch(error => {
        console.error('Error loading alliances visualization:', error);
    });
</script>

</body>
</html>
